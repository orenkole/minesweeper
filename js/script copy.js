const appElement = document.querySelector("#app")

let SIZE = 8;
let cells2DArray = [];
let table;
let numberOfBombs;

addControlsContainer()
addInputForSize();
addResultBox();

// —Å–æ–∑–¥–∞–¥–∏–º —Ç–∞–±–ª–∏—Ü—É –∏ –≤—Å—Ç–∞–≤–∏–º –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É
createAndPasteTable(SIZE);

// —Å–æ–∑–¥–∞–¥–∏–º –º–∞—Å—Å–∏–≤  –æ–±—ä–µ–∫—Ç–æ–≤ —Å —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∞–º–∏ —è—á–µ–µ–∫
let cellsProperties2DArray = createCellsPropertiesArray(SIZE)

// —Å–æ–∑–¥–∞–¥–∏–º –∫–Ω–æ–ø–∫—É "–°—Ç–∞—Ä—Ç"
addStartButton()

// –¥–æ–±–∞–≤–∏–º –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å—á–µ—Ç—á–∏–∫–∞ –º–∏–Ω
addCounter();

/** --------- start game block ----------- */

restartGameHandler()

function restartGameHandler() {
	hideResultBox();
	hideStartButton()

	clearTable()

	clearProperties()

	const numbersOfCells = getNumbersArray(SIZE * SIZE);

	numberOfBombs = Number.parseInt((SIZE * SIZE) / 6);
	console.log(numberOfBombs);

	const randomCellsNumbers = getRandomNumbers(numberOfBombs, numbersOfCells)

	const randomCoords = getRandomCoords(randomCellsNumbers, SIZE);

	placeBobms(randomCoords)

	placeNumbers ()

	refreshCounter()

	// –¥–æ–±–∞–≤–∏–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
	table.addEventListener('mousedown', onCellClick)
	table.addEventListener('dblclick', onCellDoubleClick)
	table.addEventListener('mousedown', showStartButton)
	table.addEventListener('contextmenu', toggleMark)
}

// —Å–æ–∑–¥–∞–¥–∏–º —Ç–∞–±–ª–∏—Ü—É –∏ –≤—Å—Ç–∞–≤–∏–º –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É
function createAndPasteTable(SIZE) {
	cells2DArray = Array.from({length: SIZE}, () => {
		return Array.from({length: SIZE}, () => document.createElement('td'))
	})

	// –¥–æ–±–∞–≤–∏–º –≤ data –∞—Ç—Ç—Ä–∏–±—É—Ç—ã –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã —è—á–µ–µ–∫
	cells2DArray.forEach((row, rowIndex) => {
		row.forEach((cell, columnIndex) => {
			cell.dataset.rowCoord = rowIndex;
			cell.dataset.columnCoord = columnIndex;
		})
	})

	// —Å–æ–∑–¥–∞–¥–∏–º —Ç–∞–±–ª–∏—Ü—É –∏ –¥–æ–±–∞–≤–∏–º –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É
	table = document.createElement('table')
	const tableHTML = document.createDocumentFragment()
	cells2DArray.forEach(rowArray => {
		const rowHTML = document.createDocumentFragment()
		rowHTML.append(...rowArray)
		const tr = document.createElement('tr')
		tr.append(rowHTML)
		tableHTML.append(tr)
	})
	table.append(tableHTML)
	appElement.append(table)
	return table;
}

// —Å–æ–∑–¥–∞–¥–∏–º –º–∞—Å—Å–∏–≤  –æ–±—ä–µ–∫—Ç–æ–≤ —Å —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∞–º–∏ —è—á–µ–µ–∫
function createCellsPropertiesArray(SIZE) {
	return Array.from({length: SIZE}, () => {
		return Array.from({length: SIZE}, () => new Object())
	})
}


// –¥–µ–π—Å—Ç–≤–∏–µ –Ω–∞ –ª–µ–≤—ã–π –∫–ª–∏–∫ –º—ã—à–∫–∏ - –Ω–∞–∂–∞—Ç—å –Ω–∞ —è—á–µ–π–∫—É
function onCellClick(e) {
	const td = e.target
	rowCoord = +td.dataset.rowCoord;
	columnCoord = +td.dataset.columnCoord;
	if(e.button === 0) {
		if(!cellsProperties2DArray[rowCoord][columnCoord].isClicked) {
			clickCell(td, rowCoord, columnCoord)
		}
	}
}

function clickCell(td, rowCoord, columnCoord) {
	td.style.backgroundColor = "#ddd";
	rowCoord = rowCoord;
	columnCoord = columnCoord;
	if(+cellsProperties2DArray[rowCoord][columnCoord].neighbours > 0
		&& cellsProperties2DArray[rowCoord][columnCoord].hasBomb !== true
	) {
		td.innerText = cellsProperties2DArray[rowCoord][columnCoord].neighbours;
		cellsProperties2DArray[rowCoord][columnCoord].isClicked = true;
	}
	if(cellsProperties2DArray[rowCoord][columnCoord].hasBomb === true) {
		td.innerText = "üí£";
		gameOver();
	}
	if(+cellsProperties2DArray[rowCoord][columnCoord].neighbours === 0
		&& !cellsProperties2DArray[rowCoord][columnCoord].isClicked
		&& cellsProperties2DArray[rowCoord][columnCoord].hasBomb !== true
	) {
		cellsProperties2DArray[rowCoord][columnCoord].isClicked = true;
		processNeighbours(rowCoord, columnCoord, clickCell)
	}
}

function processNeighbours(rowCoord, columnCoord, processingFn) {
	const upLeftRowCoord = rowCoord - 1;
	const upRowCoord = rowCoord - 1;
	const upRightRowCoord = rowCoord - 1;
	const leftRowCoord = rowCoord;
	const rightRowCoord = rowCoord;
	const downLeftRowCoord = rowCoord + 1;
	const downRowCoord = rowCoord + 1;
	const dowRightRowCoord = rowCoord + 1;
	const upLeftColumnCoord = columnCoord - 1;
	const upColumnCoord = columnCoord;
	const upRightColumnCoord = columnCoord + 1;
	const leftColumnCoord = columnCoord - 1;
	const rightColumnCoord = columnCoord + 1;
	const downLeftColumnCoord = columnCoord - 1;
	const downColumnCoord = columnCoord;
	const dowRightColumnCoord = columnCoord + 1;

	if(rowCoord > 0 && columnCoord > 0) {
		const upLeftCell = document.querySelector(`[data-row-coord="${upLeftRowCoord}"][data-column-coord="${upLeftColumnCoord}"]`)
		processingFn(upLeftCell, upLeftRowCoord, upLeftColumnCoord);
	}
	if(rowCoord > 0) {
		const upCell = document.querySelector(`[data-row-coord="${upRowCoord}"][data-column-coord="${upColumnCoord}"]`)
		processingFn(upCell, upRowCoord, upColumnCoord);
	}
	if(rowCoord > 0 && columnCoord < SIZE - 1) {
		const upRightCell = document.querySelector(`[data-row-coord="${upRightRowCoord}"][data-column-coord="${upRightColumnCoord}"]`)
		processingFn(upRightCell, upRightRowCoord, upRightColumnCoord);
	}
	if(columnCoord > 0) {
		const leftCell = document.querySelector(`[data-row-coord="${leftRowCoord}"][data-column-coord="${leftColumnCoord}"]`)
		processingFn(leftCell, leftRowCoord, leftColumnCoord);
	}
	if(columnCoord < SIZE - 1) {
		const rightCell = document.querySelector(`[data-row-coord="${rightRowCoord}"][data-column-coord="${rightColumnCoord}"]`)
		processingFn(rightCell, rightRowCoord, rightColumnCoord);
	}
	if(rowCoord < SIZE - 1 &&  columnCoord > 0) {
		const downLeftCell = document.querySelector(`[data-row-coord="${downLeftRowCoord}"][data-column-coord="${downLeftColumnCoord}"]`)
		processingFn(downLeftCell, downLeftRowCoord, downLeftColumnCoord);
	}
	if(rowCoord < SIZE - 1) {
		const downCell = document.querySelector(`[data-row-coord="${downRowCoord}"][data-column-coord="${downColumnCoord}"]`)
		processingFn(downCell, downRowCoord, downColumnCoord);
	}
	if(rowCoord < SIZE - 1 && columnCoord < SIZE - 1) {
		const downRightCell = document.querySelector(`[data-row-coord="${dowRightRowCoord}"][data-column-coord="${dowRightColumnCoord}"]`)
		processingFn(downRightCell, dowRightRowCoord, dowRightColumnCoord);
	}
}

function onCellDoubleClick(e) {
	const td = e.target
	const rowIndex = +td.dataset.rowCoord;
	const columnIndex = +td.dataset.columnCoord;
	if(e.button === 0) {
		if(cellsProperties2DArray[rowIndex][columnIndex].isClicked) {
			console.log(cellsProperties2DArray[rowIndex][columnIndex])
			let markedNeighbours = 0;
			if(rowIndex - 1 >= 0 && columnIndex - 1 >= 0) {
				if(cellsProperties2DArray[rowIndex - 1][columnIndex - 1].markedAsBomb) {
					markedNeighbours++;
				}
			}
			if(rowIndex - 1 >= 0) {
				if(cellsProperties2DArray[rowIndex - 1][columnIndex].markedAsBomb) {
					markedNeighbours++;
				}
			}
			if(rowIndex - 1 >= 0 && columnIndex + 1 < SIZE) {
				if(cellsProperties2DArray[rowIndex - 1][columnIndex + 1].markedAsBomb) {
					markedNeighbours++;
				}
			}
			if(columnIndex - 1 >= 0) {
				if(cellsProperties2DArray[rowIndex][columnIndex - 1].markedAsBomb) {
					markedNeighbours++;
				}
			}
			if(columnIndex + 1 < SIZE) {
				if(cellsProperties2DArray[rowIndex][columnIndex + 1].markedAsBomb) {
					markedNeighbours++;
				}
			}
			if(rowIndex + 1 < SIZE && columnIndex - 1 >= 0) {
				if(cellsProperties2DArray[rowIndex + 1][columnIndex -1].markedAsBomb) {
					markedNeighbours++;
				}
			}
			if(rowIndex + 1 < SIZE) {
				if(cellsProperties2DArray[rowIndex + 1][columnIndex].markedAsBomb) {
					markedNeighbours++;
				}
			}
			if(rowIndex + 1 < SIZE && columnIndex + 1 < SIZE) {
				if(cellsProperties2DArray[rowIndex + 1][columnIndex + 1].markedAsBomb) {
					markedNeighbours++;
				}
			}
			if(markedNeighbours === cellsProperties2DArray[rowIndex][columnIndex].neighbours){
				console.log(true)
				processNeighbours(rowIndex, columnIndex, clickOneCell)
			}
		}
	}
}

function clickOneCell(td, rowCoord, columnCoord) {
	rowCoord = rowCoord;
	columnCoord = columnCoord;
	if(cellsProperties2DArray[rowCoord][columnCoord].hasBomb !== true
	) {
		if(cellsProperties2DArray[rowCoord][columnCoord].neighbours > 0){
			td.innerText = cellsProperties2DArray[rowCoord][columnCoord].neighbours;
		}
		td.style.backgroundColor = "#ddd";
		cellsProperties2DArray[rowCoord][columnCoord].isClicked = true;
	}
	if(cellsProperties2DArray[rowCoord][columnCoord].hasBomb === true) {
		if(cellsProperties2DArray[rowCoord][columnCoord].markedAsBomb === false) {
			td.style.backgroundColor = "#ddd";
			td.innerText = "üí£";
			gameOver();
		}
	}
}


// –ø—Ä–∏ –∫–ª–∏–∫–µ –Ω–∞ –±–æ–º–±—É –ø–æ–∫–∞–∂–µ–º –±–æ–º–±—ã –∏ –∑–∞–ø—Ä–µ—Ç–∏–º –∫–ª–∏–∫–∞—Ç—å –ø–æ —Ç–∞–±–ª–∏—Ü–µ
function gameOver() {
	const resultBox = document.querySelector(".result-box");
	resultBox.textContent = "You loose!";
	resultBox.style.visibility = "visible";
	table.removeEventListener('mousedown', onCellClick);
	table.removeEventListener('contextmenu', toggleMark);
	showBombs()
}

// –ø–æ–∫–∞–∂–µ–º –º–∏–Ω—ã –µ—Å–ª–∏ –∏–≥—Ä–æ–∫ –ø—Ä–æ–∏–≥—Ä–∞–ª
function showBombs() {
	cellsProperties2DArray.forEach((rowProperty, rowIndex) => {
		rowProperty.forEach((cellProperty, columnIndex) => {
			if(cellProperty.hasBomb) {
				const td = document.querySelector(`[data-row-coord="${rowIndex}"][data-column-coord="${columnIndex}"]`)
				td.innerText = "üí£";
			}
		})
	})
}

// —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ñ–ª–∞–∂–æ–∫ –ø–æ –ø—Ä–∞–≤–æ–º—É –∫–ª–∏–∫—É
function toggleMark (e) {
	e.preventDefault()
	const td = e.target;
	if(cellsProperties2DArray[rowCoord][columnCoord].isClicked === false) {
		cellsProperties2DArray[rowCoord][columnCoord].markedAsBomb = !cellsProperties2DArray[rowCoord][columnCoord].markedAsBomb;
		if(cellsProperties2DArray[rowCoord][columnCoord].markedAsBomb) {
			td.innerText = "üí£";
		}
		else {
			td.innerText = "";
		}
	}
  // –æ–±–Ω–æ–≤–∏–º –∑–Ω–∞—á–µ–Ω–∏–µ —Å—á–µ—Ç—á–∏–∫–∞ –º–∏–Ω
  refreshCounter()
}

// —Å–æ–∑–¥–∞–¥–∏–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –∫–Ω–æ–ø–∫–∞ "–°—Ç–∞—Ä—Ç" –∏ —Å—á–µ—Ç—á–∏–∫–∞ –º–∏–Ω
function addControlsContainer() {
	const controlsContainer = document.createElement('div');
	controlsContainer.classList.add('controls-container');
	appElement.prepend(controlsContainer)
}

function addInputForSize() {
	const label = document.createElement('label');
	const input = document.createElement('input');
	input.value = 8;
	const setSizeBtn = document.createElement('button');
	setSizeBtn.classList.add('size-btn')
	setSizeBtn.addEventListener('click', setSize)
	setSizeBtn.textContent = "–ó–∞–¥–∞—Ç—å —Ä–∞–∑–º–µ—Ä—ã –ø–æ–ª—è";
	label.prepend(input);
	label.append(setSizeBtn);
	const controlsContainer = document.querySelector('.controls-container')
	controlsContainer.prepend(label);
}

function setSize() {
	const input = document.querySelector('input');
	fieldSize = input.value;
	SIZE = +fieldSize;
	document.querySelector('table').remove();
	table = createAndPasteTable(SIZE)
	cellsProperties2DArray = createCellsPropertiesArray(SIZE)
	restartGameHandler()
}

function addResultBox() {
	const resultBox = document.createElement('p');
	resultBox.classList.add("result-box");
	resultBox.textContent = "pending";
	resultBox.style.visibility = "hidden";
	appElement.prepend(resultBox);
}

function hideResultBox() {
	const resultBox = document.querySelector('.result-box');
	resultBox.style.visibility = "hidden";
}

// —Å–æ–∑–¥–∞–¥–∏–º –∫–Ω–æ–ø–∫—É "–°—Ç–∞—Ä—Ç"
function addStartButton() {
	const startButton = document.createElement('button')
	startButton.id = 'start-button'
	startButton.innerText = "–ù–∞—á–∞—Ç—å –∏–≥—Ä—É –∑–∞–Ω–æ–≤–æ"
	const controlsContainer = document.querySelector('.controls-container')
	startButton.visibility = "hidden";
  controlsContainer.prepend(startButton)
  startButton.addEventListener('click', restartGameHandler)
  table.removeEventListener('mousedown', showStartButton)
}

function showStartButton() {
	const startButton = document.getElementById('start-button')
	startButton.style.visibility = "visible"
}
function hideStartButton() {
	const startButton = document.getElementById('start-button');
	startButton.style.visibility = "hidden"
}

// –¥–æ–±–∞–≤–∏–º –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å—á–µ—Ç—á–∏–∫–∞ –º–∏–Ω
function addCounter() {
	const counterSpan = document.createElement('span')
	counterSpan.classList.add('counter')
	const controlsContainer = document.querySelector('.controls-container')
	controlsContainer.append(counterSpan)
	counterSpan.innerText = `${numberOfBombs - refreshCounter()} of ${numberOfBombs} left`;
}

// –æ–±–Ω–æ–≤–∏–º –∑–Ω–∞—á–µ–Ω–∏–µ —Å—á–µ—Ç—á–∏–∫–∞ –º–∏–Ω
function refreshCounter() {
	console.log(numberOfBombs)
	const counterSpan = document.querySelector('.counter');
	let markedCells = 0;
	cellsProperties2DArray.forEach((rowProperty) => {
		rowProperty.forEach((cellProperty) => {
			if(cellProperty.markedAsBomb === true) {
				markedCells++
			}
		})
	})
	counterSpan.innerText = `${numberOfBombs - markedCells} of  ${numberOfBombs} left`;
	return markedCells;
}

// –ø–æ–ª—É—á–∏–º –º–∞—Å—Å–∏–≤ —Å –Ω–æ–º–µ—Ä–∞–º–∏ —è—á–µ–µ–∫, –≤—ã–∑–≤–∞–≤ getNumbersArray(—á–∏—Å–ª–æ —Å—Ç—Ä–æ–∫ * —á–∏—Å–ª–æ —Å—Ç–æ–ª–±—Ü–æ–≤)
function getNumbersArray(num) {
	let i = 0;
	const numbersArray = Array.from({length: num}, () => i++)
	return numbersArray;
}

// —Å–æ–∑–¥–∞–¥–∏–º –º–∞—Å—Å–∏–≤ —Å–ª—É—á–∞–π–Ω—ã—Ö —á–∏—Å–µ–ª, –¥–ª—è –Ω–æ–º–µ—Ä–æ–≤ —è—á–µ–µ–∫ –≤ –∫–æ—Ç–æ—Ä—ã—Ö –±—É–¥—É—Ç –±–æ–º–±—ã, –≤—ã–∑–≤–∞–≤ getRandomNumbers(—á–∏—Å–ª–æ –±–æ–º–±, –º–∞—Å—Å–∏–≤ –Ω–æ–º–µ—Ä–æ–≤ —è—á–µ–µ–∫)
function getRandomNumbers(num, array) {
	const randomNumbersArray = []
	while(num > 0) {
		const index = Math.floor(Math.random() * array.length)
		const chosenNumber = array.splice(index, 1)[0]
		randomNumbersArray.push(chosenNumber)
		num--;
	}
	return randomNumbersArray
}

// –ø–æ–ª—É—á–∏–º –º–∞—Å—Å–∏–≤ —Å–ª—É—á–∞–π–Ω—ã—Ö –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç –¥–ª—è –ø—Ä–æ—Å—Ç–∞–≤–ª–µ–Ω–∏—è –±–æ–º–±
function getRandomCoords(array, rowLength) {
	const coordsArray = []
	array.forEach(i => {
		const row = parseInt(i / rowLength);
		const column = i - rowLength * row;
		coordsArray.push([row, column])
	})
	return coordsArray;
}

// –ø–æ—Å—Ç–∞–≤–∏–º –Ω–∞ —Å–ª—É—á–∞–π–Ω—ã–µ —è—á–µ–π–∫–∏ –±–æ–º–±—ã –≤ —Å–≤–æ–π—Å—Ç–≤–∞—Ö
function placeBobms(randomCoords) {
	randomCoords.forEach(coordinates => {
		const cellProperty = cellsProperties2DArray[coordinates[0]][coordinates[1]]
		cellProperty.hasBomb = true;
	})
}

// –ø—Ä–æ—Å—Ç–∞–≤–∏–º —á–∏—Å–ª–∞ —Å–æ—Å–µ–¥–Ω–∏—Ö –±–æ–º–±
function placeNumbers () {
	// –ø—Ä–æ—Å—Ç–∞–≤–∏–º —á–∏—Å–ª–∞
	cellsProperties2DArray.forEach((rowProperty, rowIndex) => {
		rowProperty.forEach((cellProperty, columnIndex) => {
			cellProperty.markedAsBomb = false;
			let neighbours = 0;
			if(rowIndex - 1 >= 0 && columnIndex - 1 >= 0) {
				if(cellsProperties2DArray[rowIndex - 1][columnIndex - 1].hasBomb) {
					neighbours++;
				}
			}
			if(rowIndex - 1 >= 0) {
				if(cellsProperties2DArray[rowIndex - 1][columnIndex].hasBomb) {
					neighbours++;
				}
			}
			if(rowIndex - 1 >= 0 && columnIndex + 1 < SIZE) {
				if(cellsProperties2DArray[rowIndex - 1][columnIndex + 1].hasBomb) {
					neighbours++;
				}
			}
			if(columnIndex - 1 >= 0) {
				if(cellsProperties2DArray[rowIndex][columnIndex - 1].hasBomb) {
					neighbours++;
				}
			}
			if(columnIndex + 1 < SIZE) {
				if(cellsProperties2DArray[rowIndex][columnIndex + 1].hasBomb) {
					neighbours++;
				}
			}
			if(rowIndex + 1 < SIZE && columnIndex - 1 >= 0) {
				if(cellsProperties2DArray[rowIndex + 1][columnIndex -1].hasBomb) {
					neighbours++;
				}
			}
			if(rowIndex + 1 < SIZE) {
				if(cellsProperties2DArray[rowIndex + 1][columnIndex].hasBomb) {
					neighbours++;
				}
			}
			if(rowIndex + 1 < SIZE && columnIndex + 1 < SIZE) {
				if(cellsProperties2DArray[rowIndex + 1][columnIndex + 1].hasBomb) {
					neighbours++;
				}
			}
			cellsProperties2DArray[rowIndex][columnIndex].neighbours = neighbours;
		})
	})

}

// –æ—á–∏—Å—Ç–∏–º —Ç–∞–±–ª–∏—Ü—É
function clearTable() {
	cells2DArray.forEach((row) => {
		row.forEach((cell) => {
			cell.style.backgroundColor = "white";
			cell.innerText = "";
		})
	})
}

// –æ—á–∏—Å—Ç–∏–º –º–∞—Å—Å–∏–≤ —Å–≤–æ–π—Å—Ç–≤ —è—á–µ–µ–∫
function clearProperties() {
	cellsProperties2DArray.forEach((rowProperty) => {
		rowProperty.forEach((cellProperty) => {
			cellProperty.hasBomb = false;
			cellProperty.markedAsBomb = false;
			cellProperty.neighbours = 0;
			cellProperty.isClicked = false;
		})
	})
}
